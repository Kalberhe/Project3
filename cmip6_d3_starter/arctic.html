<!doctype html>
<meta charset="utf-8">
<title>Warming Acceleration and Equator Belt Anomalies (°C)</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Arial, "Noto Sans", sans-serif }
  body { margin: 24px; color: #222 }
  h2 { margin: 0 0 6px; font-size: 22px }
  p.sub { margin: 0 0 14px; font-size: 14px; color: #555 }
  .chart { margin: 28px 0; transform: scale(.75); transform-origin: top left }
  svg { max-width: 100%; height: auto }
  .axis path, .axis line { shape-rendering: crispEdges }
  .legend { font-size: 12px }
  .tooltip { pointer-events: none }
</style>

<h2>Warming Acceleration. Year to year change in anomaly</h2>
<p class="sub">How fast temperatures change each year in °C. Positive spikes mean faster warming.</p>
<div id="acceleration" class="chart"></div>

<h2>Warming Across the Pacific. 5°S to 5°N by decade</h2>
<p class="sub">Temperature near the equator between 5° South and 5° North shown decade by decade from bottom to top. Each horizontal band is a decade from 1850 at the bottom to 2010 at the top. Longitude runs left to right across the Pacific.</p>
<div id="equator-heatmap" class="chart"></div>

<script type="module">
import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm"

function movingAverage(arr, k) {
  if (!arr.length) return []
  const out = []
  for (let i = 0; i < arr.length; i++) {
    const a = Math.max(0, i - Math.floor((k - 1) / 2))
    const b = Math.min(arr.length - 1, i + Math.floor(k / 2))
    const slice = arr.slice(a, b + 1)
    out.push(d3.mean(slice, d => d.val))
  }
  return out
}

{
  const url = "arctic_vs_global_ensemble_yearly.csv"
  const margin = { top: 28, right: 220, bottom: 56, left: 64 }
  const width = 1200, height = 420
  const innerW = width - margin.left - margin.right
  const innerH = height - margin.top - margin.bottom

  const svg = d3.select("#acceleration").append("svg").attr("viewBox", [0, 0, width, height])
  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`)

  const raw = await d3.csv(url, d => ({ year: +d.year, val: +d.tas_anom_c, region: d.region }))
  const nameMap = new Map([["Arctic_60N_90N", "Arctic 60°N to 90°N"], ["Global", "Global average"]])
  raw.forEach(d => d.region = nameMap.get(d.region) ?? d.region)
  const byRegion = d3.group(raw, d => d.region)

  function toAccel(series) {
    const s = series.slice().sort((a, b) => d3.ascending(a.year, b.year))
    const out = []
    for (let i = 1; i < s.length; i++) {
      out.push({ year: s[i].year, val: s[i].val - s[i - 1].val, region: s[i].region })
    }
    return out
  }

  const acc = Array.from(byRegion.values()).flatMap(toAccel)

  const x = d3.scaleLinear().domain(d3.extent(acc, d => d.year)).range([0, innerW])
  const y = d3.scaleLinear().domain(d3.extent(acc, d => d.val)).nice().range([innerH, 0])

  const color = new Map([["Arctic 60°N to 90°N", "#d62728"], ["Global average", "#1f77b4"]])

  g.append("g").attr("class", "axis").attr("transform", `translate(0,${innerH})`)
    .call(d3.axisBottom(x).ticks(10).tickFormat(d3.format("d")))
  g.append("g").attr("class", "axis").call(d3.axisLeft(y))

  g.append("text").attr("x", innerW / 2).attr("y", innerH + 40).attr("text-anchor", "middle").text("Year")
  g.append("text").attr("transform", `rotate(-90)`).attr("x", -innerH / 2).attr("y", -50).attr("text-anchor", "middle").text("Change in anomaly (°C per year)")

  g.append("line").attr("x1", 0).attr("x2", innerW).attr("y1", y(0)).attr("y2", y(0)).attr("stroke", "#aaa").attr("stroke-dasharray", "4,4")

  const line = d3.line().x(d => x(d.year)).y(d => y(d.val))
  const area = d3.area().x(d => x(d.year)).y0(y(0)).y1(d => y(d.val))

  const accByRegion = d3.group(acc, d => d.region)
  for (const [name, arr] of accByRegion) {
    const data = arr.slice().sort((a, b) => d3.ascending(a.year, b.year))
    g.append("path").attr("fill", color.get(name)).attr("opacity", 0.15).attr("d", area(data))
    g.append("path").attr("fill", "none").attr("stroke", color.get(name)).attr("stroke-width", 2).attr("d", line(data))
  }

  const tip = g.append("g").attr("class", "tooltip").style("display", "none")
  tip.append("rect").attr("width", 230).attr("height", 44).attr("fill", "white").attr("stroke", "#ccc").attr("rx", 4)
  const ttext = tip.append("text").attr("x", 6).attr("y", 16).style("font-size", 12)

  for (const [name, arr] of accByRegion) {
    const data = arr.slice().sort((a, b) => d3.ascending(a.year, b.year))
    g.append("path")
      .attr("fill", "none")
      .attr("stroke", "transparent")
      .attr("stroke-width", 14)
      .attr("pointer-events", "stroke")
      .attr("d", line(data))
      .on("mousemove", function(event) {
        const [mx] = d3.pointer(event, this)
        const yr = Math.round(x.invert(mx))
        const row = data.reduce((best, d) =>
          Math.abs(d.year - yr) < Math.abs((best?.year ?? Infinity) - yr) ? d : best, null)
        if (!row) return
        const lines = [`Year ${row.year}`, `${name}: ${row.val.toFixed(3)} °C per year`]
        ttext.selectAll("tspan").data(lines).join("tspan")
          .attr("x", 6)
          .attr("dy", (_, i) => i === 0 ? 0 : 14)
          .text(d => d)
        const tx = Math.min(x(row.year) + 12, innerW - 230)
        const ty = Math.max(4, Math.min(y(row.val) - 22, innerH - 44))
        tip.attr("transform", `translate(${tx},${ty})`).style("display", null)
      })
      .on("mouseout", () => tip.style("display", "none"))
  }

  const legend = svg.append("g").attr("class", "legend")
    .attr("transform", `translate(${width - margin.right + 8},${margin.top})`)
  let i = 0
  for (const name of accByRegion.keys()) {
    const yoff = i * 20
    legend.append("rect").attr("x", 0).attr("y", yoff - 8).attr("width", 12).attr("height", 12).attr("fill", color.get(name))
    legend.append("text").attr("x", 18).attr("y", yoff).attr("alignment-baseline", "middle").text(name)
    i++
  }
}

{
  const url = "equator_belt_longitude_decadal.csv"
  const margin = { top: 20, right: 70, bottom: 60, left: 80 }
  const width = 980, height = 520
  const innerW = width - margin.left - margin.right
  const innerH = height - margin.top - margin.bottom

  const svg = d3.select("#equator-heatmap").append("svg")
    .attr("viewBox", [0, 0, width, height])

  const g = svg.append("g").attr("transform", `translate(${margin.left},${margin.top})`)

  const data = await d3.csv(url, d => ({ decade: +d.decade, lon: +d.lon, val: +d.tas_anom_c_mean }))

  if (!data.some(d => d.lon === 180)) {
    const neg180 = data.filter(d => d.lon === -180)
    data.push(...neg180.map(d => ({ ...d, lon: 180 })))
  }

  const decades = Array.from(new Set(data.map(d => d.decade))).sort(d3.ascending)
  const lons = Array.from(new Set(data.map(d => d.lon))).sort(d3.ascending)

  const x = d3.scaleBand().domain(lons).range([0, innerW])
  const y = d3.scaleBand().domain(decades).range([innerH, 0])  // 1850 bottom, 2010 top

  const extent = d3.extent(data, d => d.val)
  const lim = Math.max(Math.abs(extent[0] ?? 0), Math.abs(extent[1] ?? 0)) || 1e-6
  const color = d3.scaleDiverging(d3.interpolateRdBu).domain([+lim, 0, -lim])

  g.selectAll("rect").data(data).join("rect")
    .attr("x", d => x(d.lon)).attr("y", d => y(d.decade))
    .attr("width", x.bandwidth()).attr("height", y.bandwidth())
    .attr("fill", d => color(d.val))

  const desiredTicks = d3.range(-180, 181, 30)
  const lonTicks = desiredTicks.filter(v => lons.includes(v))
  const degLabel = d => d === 0 ? "0°" : (d < 0 ? `${Math.abs(d)}°W` : `${d}°E`)

  g.append("g").attr("class", "axis").attr("transform", `translate(0,${innerH})`)
    .call(d3.axisBottom(x).tickValues(lonTicks).tickFormat(degLabel).tickSizeOuter(0))
  g.append("g").attr("class", "axis").call(d3.axisLeft(y).tickValues(decades).tickSizeOuter(0))

  g.append("text").attr("x", innerW / 2).attr("y", innerH + 44).attr("text-anchor", "middle").text("Longitude")
  g.append("text").attr("transform", `rotate(-90)`).attr("x", -innerH / 2).attr("y", -56).attr("text-anchor", "middle").text("Decade")

  const legendH = innerH
  const legendW = 14
  const legendX = margin.left + innerW + 16
  const legendY = margin.top

  const defs = svg.append("defs")
  const gradId = "grad-eq-vertical"
  const grad = defs.append("linearGradient")
    .attr("id", gradId)
    .attr("x1", "0%").attr("x2", "0%")
    .attr("y1", "100%").attr("y2", "0%")

  d3.range(0, 1.0001, 0.1).forEach(t => {
    const value = d3.interpolateNumber(-lim, lim)(t)
    grad.append("stop").attr("offset", `${t * 100}%`).attr("stop-color", color(value))
  })

  svg.append("rect")
    .attr("x", legendX).attr("y", legendY)
    .attr("width", legendW).attr("height", legendH)
    .attr("fill", `url(#${gradId})`).attr("stroke", "#ccc")

  const legendScale = d3.scaleLinear().domain([-lim, lim]).range([legendY + legendH, legendY])
  const legendAxis = d3.axisRight(legendScale).ticks(6)
  svg.append("g").attr("transform", `translate(${legendX + legendW},0)`).call(legendAxis)
  svg.append("text").attr("x", legendX + legendW + 34).attr("y", legendY - 6).attr("text-anchor", "end").text("Anomaly (°C)")

  const tip = g.append("g").attr("class", "tooltip").style("display", "none")
  tip.append("rect").attr("width", 190).attr("height", 46).attr("fill", "white").attr("stroke", "#ccc").attr("rx", 4)
  const ttext = tip.append("text").attr("x", 6).attr("y", 16).style("font-size", 12)
  const idx = d3.index(data, d => d.decade, d => d.lon)

  g.on("mousemove", function (event) {
    const [mx, my] = d3.pointer(event, this)
    const ix = Math.max(0, Math.min(x.domain().length - 1, Math.floor(mx / x.bandwidth())))
    const iy = Math.max(0, Math.min(y.domain().length - 1, Math.floor(my / y.bandwidth())))
    const dLon = x.domain()[ix]
    const dDec = y.domain()[iy]
    const d = idx.get(dDec)?.get(dLon)
    if (!d) return
    const labelLon = degLabel(dLon)
    const lines = [`Decade ${dDec}`, `Lon ${labelLon}, ${d.val.toFixed(2)} °C`]
    ttext.selectAll("tspan").data(lines).join("tspan")
      .attr("x", 6)
      .attr("dy", (_, i) => i === 0 ? 0 : 14)
      .text(v => v)
    const tx = Math.min(mx + 10, innerW - 190)
    const ty = Math.max(0, my - 24)
    tip.attr("transform", `translate(${tx},${ty})`).style("display", null)
  }).on("mouseout", () => tip.style("display", "none"))
}
</script>